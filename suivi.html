<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suivi de commande ‚Äì MTl√© Saz√≥n</title>
  <link rel="stylesheet" href="style.css">
  <script defer src="script.js"></script>
  <script defer src="panier.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabase = supabase.createClient(
      'https://pegawlulgltcxmvfirfq.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZ2F3bHVsZ2x0Y3htdmZpcmZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxMjE3ODgsImV4cCI6MjA2MzY5Nzc4OH0.qAh5nrKXV-D4EHPZNQLJoWZ81X8HDbiMmJ5Tx3dTklA'
    );
  </script>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="logo-link">
      <img src="assets/img/logo.png" alt="MTl√© Saz√≥n Logo" class="logo" />
    </a>
    <nav class="nav-desktop">
      <a href="index.html">ACCUEIL</a>
      <a href="menu.html">MENU</a>
      <a href="https://www.instagram.com/toncompteinsta" target="_blank">INSTAGRAM</a>
    </nav>
    <div class="cart-icon" onclick="window.location.href='checkout.html'">
      üõí <span id="cart-count">0</span>
    </div>
    <div class="menu-toggle" onclick="toggleMenu()">‚ò∞</div>
    <nav class="nav-mobile" id="mobileMenu">
      <a href="index.html">ACCUEIL</a>
      <a href="menu.html">MENU</a>
      <a href="https://www.instagram.com/toncompteinsta" target="_blank">INSTAGRAM</a>
      <a href="checkout.html">PANIER üõí <span id="cart-count-mobile">0</span></a>
    </nav>
  </header>

  <main class="suivi-section" style="padding: 40px 20px; text-align: center; background: #fefefe; color: #222;">
    <h1>Suivi de ta commande</h1>
    <style>
      #suivi-contenu {
        background: white;
        max-width: 500px;
        margin: 0 auto;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 12px rgba(0,0,0,0.08);
        font-size: 1rem;
        color: #222;
        text-align: left;
      }
      #suivi-contenu p {
        margin-bottom: 10px;
      }
      #suivi-contenu ul {
        margin-top: 10px;
      }
      #suivi-contenu a {
        text-decoration: none;
        display: inline-block;
        margin-top: 4px;
      }
    </style>
    <div id="suivi-contenu"></div>
  </main>
<script>
  async function afficherCommande() {
    const url = new URL(window.location.href);
    const commandeID = url.searchParams.get("id");
    const contenu = document.getElementById("suivi-contenu");

    if (!commandeID) {
      contenu.innerHTML = "<p>Commande introuvable. V√©rifie ton lien.</p>";
      return;
    }

    const { data: commande, error } = await supabase
      .from("commandes")
      .select("*")
      .eq("id", commandeID)
      .single();

    if (error || !commande) {
      contenu.innerHTML = "<p>Commande introuvable ou supprim√©e.</p>";
      return;
    }

    const statutLabel = {
      "envoy√©": "üü° Envoy√©e",
      "accept√©": "üü† Accept√©e",
      "pr√™t": "‚úÖ Pr√™te",
      "termin√©e": "üî¥ Termin√©e"
    };

    const dateCmd = new Date(commande.heure_commande);
    const now = new Date();
    const delaiMs = 15 * 60 * 1000 - (now - dateCmd);
    const tempsRestant = Math.max(0, delaiMs);
    const minutes = Math.floor(tempsRestant / 60000);
    const seconds = Math.floor((tempsRestant % 60000) / 1000);

    const produits = commande.produits.map(p => `‚Ä¢ ${p.nom} x${p.quantite}`).join("<br>");

    const baseURL = window.location.origin + window.location.pathname;
    const suiviURL = `${baseURL}?id=${commandeID}`;

    const estExpiree = commande.statut === "termin√©e" || tempsRestant <= 0;

    contenu.innerHTML = `
      <p><strong>Commande :</strong> ${commandeID}</p>
      <p><strong>Statut :</strong> ${statutLabel[commande.statut]}</p>
      <p><strong>Produits :</strong><br>${produits}</p>
      <p><strong>Lieu :</strong> ${commande.message ? commande.message : "√Ä retirer sur place"}</p>
      <p><strong>Estimation :</strong> ${estExpiree ? "Commande expir√©e ou livr√©e." : `${minutes} min ${seconds}s restantes`}</p>
      <p style="margin-top: 30px;">Tu peux partager ce lien de suivi :</p>
      <ul style="list-style: none; padding: 0;">
        <li><a href="https://wa.me/?text=Voici ton lien de suivi MTl√© Saz√≥n : ${encodeURIComponent(suiviURL)}" target="_blank" style="color: #25D366; font-weight: bold;">üì± WhatsApp</a></li>
        <li><a href="mailto:?subject=Suivi de commande MTl√© Saz√≥n&body=Voici ton lien de suivi : ${encodeURIComponent(suiviURL)}" style="color: #0072c6; font-weight: bold;">‚úâÔ∏è E-mail</a></li>
        <li><a href="${suiviURL}" style="color: #555; font-weight: bold;">üîó Lien direct</a></li>
      </ul>
    `;

    if (!estExpiree) {
      setTimeout(afficherCommande, 1000); // auto-refresh
    }
  }

  afficherCommande();
</script>
</body>
</html>
