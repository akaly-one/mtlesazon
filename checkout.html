<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valider ma commande ‚Äì MTl√© Saz√≥n</title>
  <link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabase = supabase.createClient(
    'https://YOUR_PROJECT.supabase.co',
    'YOUR_ANON_KEY'
  );
</script>
</head>
  <script defer src="script.js"></script>
  <script defer src="panier.js"></script>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="logo-link">
      <img src="assets/img/logo.png" alt="MTl√© Saz√≥n Logo" class="logo" />
    </a>
    <nav class="nav-desktop">
      <a href="index.html">ACCUEIL</a>
      <a href="menu.html">MENU</a>
      <a href="https://www.instagram.com/toncompteinsta" target="_blank">INSTAGRAM</a>
    </nav>
    <div class="cart-icon" onclick="window.location.href='checkout.html'">
      üõí <span id="cart-count">0</span>
    </div>
    <div class="menu-toggle" onclick="toggleMenu()">‚ò∞</div>
    <nav class="nav-mobile" id="mobileMenu">
      <a href="index.html">ACCUEIL</a>
      <a href="menu.html">MENU</a>
      <a href="https://www.instagram.com/toncompteinsta" target="_blank">INSTAGRAM</a>
      <a href="checkout.html">PANIER üõí <span id="cart-count-mobile">0</span></a>
    </nav>
  </header>

  <main class="checkout-section" style="padding: 40px 20px; background: #fefefe;">
    <h1 style="text-align: center;">Valider ma commande</h1>
    <div id="recap-panier" style="max-width: 500px; margin: auto; margin-bottom: 30px; background: #f9f9f9; padding: 15px; border-radius: 10px;">
      <h2 style="text-align: center;">R√©capitulatif</h2>
      <ul id="liste-panier" style="list-style:none; padding: 0;">
        <!-- Exemple d'un produit ins√©r√© dynamiquement -->
        <!-- Ce bloc sera clon√© via JS -->
        <li class="ligne-panier" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <img src="assets/img/emp-poulet.jpeg" alt="Empanada" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" />
          <div>
            <strong>Nom du produit</strong><br />
            <small>Quantit√© : 2</small>
          </div>
        </li>
        <!-- Fin exemple -->
      </ul>
      <p id="total-panier" style="text-align:center; font-weight: bold; margin-top: 10px;"></p>
      <a href="menu.html" style="display:block; text-align:center; margin-top:10px; color:#d94f30;">Modifier ma commande</a>
    </div>
    <form id="form-checkout" onsubmit="return afficherConfirmation(event);" style="max-width: 500px; margin: auto;">
      <input type="text" placeholder="Nom complet" required style="width:100%;margin-bottom:10px;padding:10px;" />
      <input type="tel" placeholder="T√©l√©phone" required style="width:100%;margin-bottom:10px;padding:10px;" />
      <input type="email" placeholder="Email (optionnel)" style="width:100%;margin-bottom:10px;padding:10px;" />
      <input type="text" placeholder="Adresse (si livraison)" style="width:100%;margin-bottom:20px;padding:10px;" />
      <button type="submit" style="width:100%;background-color:#d94f30;color:white;padding:15px;border:none;border-radius:5px;font-weight:bold;font-size:1.1em;">Confirmer la commande</button>
    </form>

    <div id="confirmation" style="display: none; margin-top: 30px; text-align:center;">
      <h2>Merci pour ta commande !</h2>
      <p>Tu peux suivre son statut ici :</p>
      <p><a id="suivi-link" href="#" style="color:#d94f30;font-weight:bold;">Suivre ma commande</a></p>
      <p>Tu peux aussi recevoir le lien via :</p>
      <ul style="list-style: none; padding: 0;">
        <li><a id="suivi-whatsapp" target="_blank" style="color: #25D366; font-weight: bold;">üì± WhatsApp</a></li>
        <li><a id="suivi-mail" style="color: #0072c6; font-weight: bold;">‚úâÔ∏è E-mail</a></li>
      </ul>
    </div>
  </main>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const listePanier = document.getElementById("liste-panier");
    const totalPanier = document.getElementById("total-panier");

    const panier = JSON.parse(localStorage.getItem("panier")) || [];
    let total = 0;

    if (panier.length === 0) {
      listePanier.innerHTML = "<p style='text-align:center;'>Ton panier est vide.</p>";
      totalPanier.textContent = "";
      return;
    }

    // Vider la liste initiale (exemple statique)
    listePanier.innerHTML = "";

    panier.forEach(produit => {
      const item = document.createElement("li");
      item.className = "ligne-panier";
      item.style.display = "flex";
      item.style.alignItems = "center";
      item.style.gap = "10px";
      item.style.marginBottom = "6px";

      const image = document.createElement("img");
      image.src = "assets/img/emp-poulet.jpeg"; // Optionnel : adapter selon l'ID produit
      image.alt = "Produit";
      image.style.width = "50px";
      image.style.height = "50px";
      image.style.objectFit = "cover";
      image.style.borderRadius = "8px";

      const desc = document.createElement("div");
      desc.innerHTML = `<strong>${produit.nom}</strong><br /><small>Quantit√© : ${produit.quantite}</small>`;

      item.appendChild(image);
      item.appendChild(desc);
      listePanier.appendChild(item);

      total += produit.prix * produit.quantite;
    });

    totalPanier.textContent = `Total : ${total.toFixed(2)} ‚Ç¨`;
  });

  async function afficherConfirmation(event) {
    event.preventDefault();

    const bouton = event.target.querySelector("button[type='submit']");
    bouton.disabled = true;
    bouton.textContent = "Enregistrement...";

    const panier = JSON.parse(localStorage.getItem("panier")) || [];
    if (panier.length === 0) {
      alert("Le panier est vide.");
      bouton.disabled = false;
      bouton.textContent = "Confirmer la commande";
      return false;
    }

    const nom = document.querySelector("input[placeholder='Nom complet']").value.trim();
    const tel = document.querySelector("input[placeholder='T√©l√©phone']").value.trim();
    const email = document.querySelector("input[placeholder='Email (optionnel)']").value.trim();
    const adresse = document.querySelector("input[placeholder='Adresse (si livraison)']").value.trim();

    // 1. Ajouter ou mettre √† jour le client
    await supabase
      .from("clients")
      .upsert([{ nom, tel, email }], { onConflict: "tel" });

    // 2. Cr√©er la commande
    const { data: commande, error } = await supabase
      .from("commandes")
      .insert([{
        client_tel: tel,
        produits: panier,
        message: adresse,
        statut: "envoy√©"
      }])
      .select()
      .single();

    if (error) {
      alert("Erreur lors de l'enregistrement de la commande.");
      console.error(error);
      bouton.disabled = false;
      bouton.textContent = "Confirmer la commande";
      return false;
    }

    // 3. G√©n√©rer le lien de suivi
    const orderId = commande.id;
    document.getElementById("form-checkout").style.display = "none";
    const confirmationDiv = document.getElementById("confirmation");
    confirmationDiv.style.display = "block";

    const baseURL = window.location.origin + "/suivi.html?id=" + orderId;

    document.getElementById("suivi-link").href = baseURL;

    const numeroWhatsApp = "32475123456";
    document.getElementById("suivi-whatsapp").href =
      `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent("Salut, je viens de commander sur MTl√© Saz√≥n. Voici mon lien de suivi : " + baseURL)}`;

    document.getElementById("suivi-mail").href =
      `mailto:?subject=Suivi de commande MTl√© Saz√≥n&body=Voici ton lien de suivi : ${encodeURIComponent(baseURL)}`;

    // Ajouter un bouton de retour
    const retourBtn = document.createElement("a");
    retourBtn.href = "menu.html";
    retourBtn.textContent = "‚Üê Revenir au menu";
    retourBtn.style.display = "block";
    retourBtn.style.marginTop = "20px";
    retourBtn.style.color = "#d94f30";
    retourBtn.style.fontWeight = "bold";

    confirmationDiv.appendChild(retourBtn);

    return false;
  }
</script>
</body>
</html>