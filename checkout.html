<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valider ma commande ‚Äì MTl√© Saz√≥n</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabase = supabase.createClient(
      'https://YOUR_PROJECT.supabase.co',
      'YOUR_ANON_KEY'
    );
  </script>
  <script defer src="script.js"></script>
  <script defer src="panier.js"></script>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="logo-link">
      <img src="assets/img/logo.png" alt="MTl√© Saz√≥n Logo" class="logo" />
    </a>
    <nav class="nav-desktop">
      <a href="index.html">ACCUEIL</a>
      <a href="menu.html">MENU</a>
      <a href="https://www.instagram.com/toncompteinsta" target="_blank">INSTAGRAM</a>
    </nav>
    <div class="cart-icon" onclick="window.location.href='checkout.html'">
      üõí <span id="cart-count">0</span>
    </div>
    <div class="menu-toggle" onclick="toggleMenu()">‚ò∞</div>
    <nav class="nav-mobile" id="mobileMenu">
      <a href="index.html">ACCUEIL</a>
      <a href="menu.html">MENU</a>
      <a href="https://www.instagram.com/toncompteinsta" target="_blank">INSTAGRAM</a>
      <a href="checkout.html" class="cart-link-mobile">PANIER üõí <span id="cart-count-mobile">0</span></a>
    </nav>
  </header>

  <main class="checkout-section">
    <h1 class="checkout-title">Valider ma commande</h1>
    <div id="recap-panier" class="recap-panier">
      <h2 class="recap-title">R√©capitulatif</h2>
      <ul id="liste-panier" class="liste-panier">
        <!-- Exemple d'un produit ins√©r√© dynamiquement -->
        <!-- Ce bloc sera clon√© via JS -->
        <li class="ligne-panier">
          <img src="assets/img/emp-poulet.jpeg" alt="Empanada" class="ligne-panier-img" />
          <div class="ligne-panier-desc">
            <strong>Nom du produit</strong><br />
            <small>Quantit√© : 2</small>
          </div>
        </li>
        <!-- Fin exemple -->
      </ul>
      <p id="total-panier" class="total-panier"></p>
      <a href="menu.html" class="modifier-commande-link">Modifier ma commande</a>
    </div>
    <form id="form-checkout" onsubmit="return afficherConfirmation(event);" class="form-checkout">
      <input type="text" placeholder="Nom complet" required class="input-field" />
      <input type="tel" placeholder="T√©l√©phone" required class="input-field" />
      <input type="email" placeholder="Email (optionnel)" class="input-field" />
      <input type="text" placeholder="Adresse (si livraison)" class="input-field" />
      <button type="submit" class="btn-submit">Confirmer la commande</button>
    </form>

    <div id="confirmation" class="confirmation" style="display: none;">
      <h2>Merci pour ta commande !</h2>
      <p>Tu peux suivre son statut ici :</p>
      <p><a id="suivi-link" href="#" class="suivi-link">Suivre ma commande</a></p>
      <p>Tu peux aussi recevoir le lien via :</p>
      <ul class="suivi-list">
        <li><a id="suivi-whatsapp" target="_blank" class="suivi-whatsapp">üì± WhatsApp</a></li>
        <li><a id="suivi-mail" class="suivi-mail">‚úâÔ∏è E-mail</a></li>
      </ul>
    </div>
  </main>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const listePanier = document.getElementById("liste-panier");
    const totalPanier = document.getElementById("total-panier");

    const panier = JSON.parse(localStorage.getItem("panier")) || [];
    let total = 0;

    if (panier.length === 0) {
      listePanier.innerHTML = "<p style='text-align:center;'>Ton panier est vide.</p>";
      totalPanier.textContent = "";
      return;
    }

    // Vider la liste initiale (exemple statique)
    listePanier.innerHTML = "";

    panier.forEach(produit => {
      const item = document.createElement("li");
      item.className = "ligne-panier";
      item.style.display = "flex";
      item.style.alignItems = "center";
      item.style.gap = "10px";
      item.style.marginBottom = "6px";

      const image = document.createElement("img");
      image.src = "assets/img/emp-poulet.jpeg"; // Optionnel : adapter selon l'ID produit
      image.alt = "Produit";
      image.style.width = "50px";
      image.style.height = "50px";
      image.style.objectFit = "cover";
      image.style.borderRadius = "8px";

      const desc = document.createElement("div");
      desc.innerHTML = `<strong>${produit.nom}</strong><br /><small>Quantit√© : ${produit.quantite}</small>`;

      item.appendChild(image);
      item.appendChild(desc);
      listePanier.appendChild(item);

      total += produit.prix * produit.quantite;
    });

    totalPanier.textContent = `Total : ${total.toFixed(2)} ‚Ç¨`;
  });

  async function afficherConfirmation(event) {
    event.preventDefault();

    const bouton = event.target.querySelector("button[type='submit']");
    bouton.disabled = true;
    bouton.textContent = "Enregistrement...";

    const panier = JSON.parse(localStorage.getItem("panier")) || [];
    if (panier.length === 0) {
      alert("Le panier est vide.");
      bouton.disabled = false;
      bouton.textContent = "Confirmer la commande";
      return false;
    }

    const nom = document.querySelector("input[placeholder='Nom complet']").value.trim();
    const tel = document.querySelector("input[placeholder='T√©l√©phone']").value.trim();
    const email = document.querySelector("input[placeholder='Email (optionnel)']").value.trim();
    const adresse = document.querySelector("input[placeholder='Adresse (si livraison)']").value.trim();

    // 1. Ajouter ou mettre √† jour le client
    await supabase
      .from("clients")
      .upsert([{ nom, tel, email }], { onConflict: "tel" });

    // 2. Cr√©er la commande
    const { data: commande, error } = await supabase
      .from("commandes")
      .insert([{
        client_tel: tel,
        produits: panier,
        message: adresse,
        statut: "envoy√©",
        heure_commande: new Date().toISOString()
      }])
      .select()
      .single();

    if (error) {
      alert("Erreur lors de l'enregistrement de la commande.");
      console.error(error);
      bouton.disabled = false;
      bouton.textContent = "Confirmer la commande";
      return false;
    }

    // 3. G√©n√©rer le lien de suivi
    const orderId = commande.id;
    document.getElementById("form-checkout").style.display = "none";
    const confirmationDiv = document.getElementById("confirmation");
    confirmationDiv.style.display = "block";

    const baseURL = window.location.origin + "/suivi.html?id=" + orderId;

    document.getElementById("suivi-link").href = baseURL;

    const numeroWhatsApp = "32475123456";
    document.getElementById("suivi-whatsapp").href =
      `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent("Salut, je viens de commander sur MTl√© Saz√≥n. Voici mon lien de suivi : " + baseURL)}`;

    document.getElementById("suivi-mail").href =
      `mailto:?subject=Suivi de commande MTl√© Saz√≥n&body=Voici ton lien de suivi : ${encodeURIComponent(baseURL)}`;

    // Ajouter un bouton de retour
    const retourBtn = document.createElement("a");
    retourBtn.href = "menu.html";
    retourBtn.textContent = "‚Üê Revenir au menu";
    retourBtn.className = "retour-btn";

    confirmationDiv.appendChild(retourBtn);

    return false;
  }
</script>
</body>
</html>